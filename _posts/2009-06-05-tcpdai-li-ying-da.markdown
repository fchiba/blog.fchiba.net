---
layout: post
title: "TCP代理応答"
date: 2009-06-05 02:28
comments: 
categories: 
author: fumiya_chiba
permalink: archives/172443.html
---

アライドテレシスのルーター(AR415S)を使っていて起きたトラブル。<br>
<br>
携帯向けのサイトを作っていたのだが、ドコモ携帯からのレスポンスが悪いという現象が発生した。最初は、ドコモだけ電波が悪いのかとも思ったのだが、コンテンツが大きくても小さくても常に1秒遅れるという奇妙な振る舞いだった。<br>
<br>
原因を調べていくと、ルーターのTCP代理応答という機能に問題があることが判明。<br>
<br>
この機能は、外から中へのTCP SYNパケットに対して、内側の機器が反応する前に、代理で返答してくれるというもの。（SYN Floodに対応するための機能らしい）<br>
<br>
具体的には、<br>
<pre><br>
クライアント         ルーター              サーバー<br>
  ｜  (1)SYN→        ｜                       ｜<br>
  ｜                       ｜  (2)SYN→        ｜<br>
  ｜                       ｜  (3)←SYN/ACK｜<br>
  ｜  (4)←SYN/ACK｜                       ｜<br>
  ｜  (5)ACK→       .｜                       ｜<br>
  ｜                       ｜  (6)ACK→       .｜<br>
  ｜  (7)データ→.    .｜                       ｜<br>
  ｜                       ｜  (8)データ→.    .｜<br>
  ｜                       ｜  (9)←ACK       .｜<br>
  ｜  (10)←ACK      ｜                       ｜<br>
  ｜             …      .｜                       ｜<br>
</pre><br>
が<br>
<pre><br>
クライアント          ルーター          サーバー<br>
  ｜  (1)SYN→        ｜                        ｜<br>
  ｜  (2)←SYN/ACK｜  (A)SYN→        .｜<br>
  ｜                       ｜  (B)←SYN/ACK.｜<br>
  ｜                       ｜  (C)ACK→　      ｜<br>
  ｜  (3)ACK→       .｜                        ｜<br>
  ｜  (4)データ→.    .｜                        ｜<br>
  ｜                       ｜  (5)データ→.     .｜<br>
  ｜                       ｜  (6)←ACK        .｜<br>
  ｜  (7)←ACK       .｜                        ｜<br>
  ｜        …           .｜                        ｜<br>
</pre><br>
となる。（クライアント～ルーターのハンドシェイク((2)～(3))とルーター～サーバーのハンドシェイク((A)～(C))が独立して行われる。<br>
<br>
今回、ドコモで問題となったのは、docomoのゲートウェイ(GW)が、(3)のACKのパケットにデータを乗せてきていたため、<br>
<pre><br>
ドコモ GW　　　   　　ルーター　　          　サーバー<br>
　｜　(1)SYN→　　　　   ｜　　　　　　        　 ｜<br>
　｜　(2)←SYN/ACK    ｜　(A)SYN→　　    .｜<br>
　｜　　　　　    　　   　　｜　(B)←SYN/ACK ｜<br>
　｜　　　　　　　       　　｜　(C)ACK→　    　｜<br>
　｜　(3)ACK+データ→ ｜　　          　　　　　｜このデータは捨てられてしまう<br>
　｜       　　　　　　　　　｜　　　　　　　         ｜<br>
　｜　　　       　　　　　　｜　　　　         　　　｜GWは(3)に対するACKを待つが、サーバーには届いてないので来ない<br>
　｜　　　　　　       　　　｜　　         　　　　　｜<br>
　｜　(4)データ再送→   ｜　         　　　　　　｜ACKが来ないので再送<br>
　｜　　　       　　　　　　｜　(5)データ→       ｜<br>
　｜　　　　　　       　　　｜　(6)←ACK　       ｜<br>
　｜　(7)←ACK　　　   　｜         　　　　　　　｜<br>
　｜　    　　…　　  　  　｜　          　 　　　　｜<br>
</pre><br>
<br>
となっていた。<br>
その後の通信はスムーズに進むため、再送がかかるまでの時間（(3)～(4)）だけ遅れが発生していた。この時間がちょうど1秒。<br>
<br>
体感的にも我慢のできない遅れであり、サーバーでもSYN Floodには対応できるため、この機能はオフにすることに。<br>
DISABLE FIREWALL POLICY=policy TCPSETUPPROXY<br>
というコマンドを入力し無事解決。<br>
<br>
ところで、ハンドシェイクのACKにデータを乗せるってのはRFC的にアリなんだろうか？？？<br>
（教科書的には、ACKとデータは別になってるよなぁ）<br>
特に問題にはなっていないので、アリなんだとは思うが、あとで調べてみよう。<br>



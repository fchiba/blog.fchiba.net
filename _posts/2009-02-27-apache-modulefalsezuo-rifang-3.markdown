---
layout: post
title: "Apache Moduleの作り方(3)"
date: 2009-02-27 01:13
comments: 
categories: 
author: fumiya_chiba
permalink: archives/172439.html
---

・その７<br>
mod_backtraceで、どの関数で落ちたか分かるようになってそれはそれで便利に。<br>
が、やっぱりデバッガ使いたい。<br>
（エラー箇所のメモリの番地しかわからず、addr2lineの使い方もよくわからん）<br>
<br>
今回作ろうとしているものは、「XMLを入力にして、データをかき集めて加工し、(XMLとは)別な形式で出力する」というもの。<br>
あまりapacheのアーキテクチャーとは関係のない部分が多かったので、コマンドラインからも動かせるようにリファクタリング。(APRには依存しても、apacheには依存しないように修正）<br>
<br>
一番のネックはロギングで、一番末端のロジックまでapacheが密着してしまっている。<br>
マルチスレッドに対応しないといけないので、グローバル変数に頼るわけにもいかず困った。<br>
<br>
結局、ログ出力関数をloggerクラスとしてラップし、これを各クラスで持ちまわすことで対応。<br>
（ロジック中は抽象クラスで書いて、モジュール版はap_log_rerrorに出力するサブクラス、コマンドライン版ではstderrに出力するサブクラスをリンク）<br>


